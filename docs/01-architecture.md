# Архитектурный план

**Проект:** NiceMusicLibrary
**Версия документа:** 1.0
**Дата:** 2025-01

---

## Сравнение архитектур

### Монолитная архитектура

**Описание:** Единое приложение с объединённым фронтендом и бэкендом.

#### Преимущества

| Название | Описание |
|----------|----------|
| Простота развёртывания | Одно приложение для деплоя, меньше конфигурации |
| Меньше накладных расходов | Нет сетевых задержек между компонентами |
| Простота разработки на старте | Быстрый запуск проекта, меньше инфраструктуры |
| Единая кодовая база | Легче отслеживать изменения и зависимости |

#### Недостатки

| Название | Описание |
|----------|----------|
| Сложность масштабирования | Масштабируется только целиком, не отдельные части |
| Технологическая привязка | Сложно использовать разные технологии для разных частей |
| Риск при обновлениях | Изменения в одной части могут сломать другую |
| Ограниченная гибкость UI | Сложнее создать современный SPA-интерфейс |

### Раздельный бэкенд и фронтенд

**Описание:** Раздельные приложения: REST/GraphQL API + SPA фронтенд.

#### Преимущества

| Название | Описание |
|----------|----------|
| Независимое масштабирование | Фронтенд и бэкенд масштабируются отдельно |
| Гибкость технологий | Разные языки и фреймворки для разных частей |
| Параллельная разработка | Команды фронтенда и бэкенда работают независимо |
| Лучший UX | Современные SPA-фреймворки для плавного интерфейса |
| Переиспользование API | Один API для веб, мобильных и десктоп клиентов |
| Кэширование | Статические ресурсы фронтенда легко кэшировать через CDN |

#### Недостатки

| Название | Описание |
|----------|----------|
| Сложность инфраструктуры | Два отдельных деплоя, CORS, прокси |
| Начальные накладные расходы | Больше настройки на старте проекта |
| Сетевые задержки | API-запросы добавляют латентность |

---

## Выбор архитектуры

**Выбранный подход:** Раздельный бэкенд и фронтенд

### Основные причины выбора

1. **Интерактивный плеер**

   Функциональность музыкального плеера требует отзывчивого SPA-интерфейса. Создание "цепочек настроений" с плавными переходами между треками лучше реализуется с помощью Vue.js.

2. **Офлайн-возможности**

   PWA/Service Workers позволят кэшировать треки и работать без интернета. Это критично для музыкального приложения.

3. **Будущее расширение**

   Единый API позволит в будущем создать мобильное приложение или десктоп-клиент без изменения бэкенда.

4. **Оптимизация под музыку**

   Стриминг аудио, предзагрузка следующего трека, визуализации — всё это требует контроля на стороне клиента.

### Дополнительные причины

- Возможность использования CDN для статики и аудиофайлов
- Независимое обновление UI без перезапуска бэкенда
- Современные практики веб-разработки

---

## Компоненты системы

### Backend (API Server)

**Основная технология:** Python + FastAPI

**Альтернативы:**
- Node.js + Express/Fastify
- Go + Gin

**Зоны ответственности:**
- REST API для всех операций с данными
- Аутентификация и авторизация (JWT)
- Управление музыкальными файлами
- Бизнес-логика цепочек настроений
- Статистика прослушиваний
- Алгоритмы рекомендаций

#### Подкомпоненты

| Сервис | Описание |
|--------|----------|
| Auth Service | Регистрация, логин, сессии, JWT токены |
| Music Service | CRUD операции с песнями, загрузка файлов |
| Playlist Service | Управление плейлистами и цепочками настроений |
| Stats Service | Трекинг прослушиваний, статистика, аналитика |
| Recommendation Engine | Алгоритмы предложения следующего трека |

### Frontend (Web Client SPA)

**Основная технология:** Vue.js 3 + TypeScript

**Альтернативы:**
- Svelte
- React

**Зоны ответственности:**
- Пользовательский интерфейс
- Аудио-плеер
- Управление состоянием (Pinia)
- Офлайн-кэширование (Service Worker)
- PWA функциональность

#### Подкомпоненты

| Компонент | Описание |
|-----------|----------|
| Player Component | Воспроизведение, очередь, контролы |
| Library View | Просмотр и управление музыкальной библиотекой |
| Mood Chain Builder | Интерфейс создания цепочек настроений |
| Stats Dashboard | Визуализация статистики прослушиваний |

### Database (Data Storage)

**Основная технология:** PostgreSQL

**Альтернативы:**
- SQLite (для простых случаев)
- MySQL

**Зоны ответственности:**
- Хранение метаданных песен
- Данные пользователей
- Плейлисты и цепочки настроений
- История прослушиваний
- Статистика и аналитика

### File Storage (Audio File Storage)

**Основная технология:** Локальная файловая система

**Опции масштабирования:**
- MinIO (S3-совместимое хранилище)
- AWS S3
- Cloudflare R2

**Зоны ответственности:**
- Хранение аудиофайлов
- Стриминг контента
- Кэширование

### Cache (Caching Layer)

**Основная технология:** Redis

**Альтернатива:** In-memory (для начала)

**Зоны ответственности:**
- Кэширование частых запросов
- Сессии пользователей
- Очередь воспроизведения
- Real-time данные плеера

---

## Взаимодействие компонентов

### Основные потоки данных

#### Аутентификация пользователя

1. Frontend → API Server: `POST /auth/login` с credentials
2. API Server → Database: Проверка пользователя
3. API Server → Cache (Redis): Сохранение сессии
4. API Server → Frontend: JWT токен

#### Воспроизведение трека

1. Frontend → API Server: `GET /songs/{id}/stream`
2. API Server → File Storage: Получение аудиофайла
3. API Server → Frontend: Стриминг аудио (byte-range)
4. Frontend → API Server: `POST /stats/play` для трекинга

#### Получение следующего трека в цепочке настроений

1. Frontend → API Server: `GET /mood-chains/{id}/next?current={songId}`
2. API Server → Database: Получение параметров цепочки
3. API Server → Recommendation Engine: Расчёт следующего трека
4. API Server → Frontend: Предложенные треки с весами

### Протоколы взаимодействия

| Протокол | Назначение |
|----------|------------|
| REST JSON | Формат API |
| JWT Bearer Token | Аутентификация |
| HTTP Range Requests | Стриминг аудио |
| WebSocket | Real-time синхронизация плеера |

---

## Диаграмма архитектуры

```
┌─────────────────────────────────────────────────────────────────┐
│                         КЛИЕНТ                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  Vue.js SPA (PWA)                           │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │ │
│  │  │  Player  │ │  Library │ │  Mood    │ │  Stats   │       │ │
│  │  │Component │ │  View    │ │  Builder │ │Dashboard │       │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │ │
│  │                    │                                        │ │
│  │              State Management (Pinia)                       │ │
│  └─────────────────────────────────────────────────────────────┘ │
└───────────────────────────────┬─────────────────────────────────┘
                                │ REST API / WebSocket
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       NGINX / API Gateway                        │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     API SERVER (FastAPI)                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │
│  │   Auth   │ │  Music   │ │ Playlist │ │   Recommendation │   │
│  │ Service  │ │ Service  │ │ Service  │ │      Engine      │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘   │
└───────┬───────────────┬─────────────────────────┬───────────────┘
        │               │                         │
        ▼               ▼                         ▼
┌──────────────┐ ┌──────────────┐         ┌──────────────┐
│  PostgreSQL  │ │ File Storage │         │    Redis     │
│  (metadata)  │ │   (audio)    │         │   (cache)    │
└──────────────┘ └──────────────┘         └──────────────┘
```

---

## Безопасность

### Аутентификация

| Параметр | Значение |
|----------|----------|
| Метод | JWT (JSON Web Tokens) |
| Время жизни токенов | 15 минут access, 7 дней refresh |
| Хранение | HttpOnly cookies для refresh, memory для access |

### Авторизация

**Модель:** RBAC (Role-Based Access Control)

| Роль | Разрешения |
|------|------------|
| user | read:own, write:own |
| admin | read:all, write:all, manage:users |

### Защита данных

- HTTPS для всех соединений
- Bcrypt для хэширования паролей
- Rate limiting для API
- Input validation и sanitization
- CORS настройка для доверенных доменов

---

## Масштабирование

### Фаза 1: MVP

**Описание:** Один сервер для всего

**Компоненты:**
- Docker Compose с backend, frontend, PostgreSQL, Redis
- Локальное файловое хранилище

**Ёмкость:** До 100 активных пользователей

### Фаза 2: Рост

**Описание:** Разделение нагрузки

**Компоненты:**
- Отдельные контейнеры за load balancer
- Managed PostgreSQL (RDS/Cloud SQL)
- Redis Cluster
- S3/MinIO для файлов + CDN

**Ёмкость:** До 10,000 пользователей

### Фаза 3: Масштаб

**Описание:** Микросервисы и горизонтальное масштабирование

**Компоненты:**
- Kubernetes для оркестрации
- Разбиение на микросервисы
- Event-driven архитектура (очереди)
- Географически распределённый CDN

**Ёмкость:** 100,000+ пользователей
