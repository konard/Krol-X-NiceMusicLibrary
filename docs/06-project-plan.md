# Поэтапный план реализации

**Проект:** NiceMusicLibrary
**Версия документа:** 1.0
**Дата:** 2025-01

---

## Обзор проекта

**Название:** NiceMusicLibrary
**Описание:** Персональная музыкальная библиотека с расширенными функциями

### Ключевые функции

- Загрузка и организация личной музыки
- Современный веб-плеер
- Плейлисты и цепочки настроений
- Статистика прослушиваний
- Интеллектуальные рекомендации

### Технологический стек

#### Backend

| Технология | Версия/Описание |
|------------|-----------------|
| Язык | Python 3.11+ |
| Фреймворк | FastAPI |
| База данных | PostgreSQL 15+ |
| Кэш | Redis |
| ORM | SQLAlchemy 2.0 |
| Миграции | Alembic |

#### Frontend

| Технология | Версия/Описание |
|------------|-----------------|
| Фреймворк | Vue.js 3 + TypeScript |
| Состояние | Pinia |
| Стили | Tailwind CSS |
| Сборка | Vite |
| Тестирование | Vitest + Vue Test Utils |

#### Инфраструктура

| Технология | Описание |
|------------|----------|
| Контейнеризация | Docker + Docker Compose |
| CI/CD | GitHub Actions |
| Деплой | Docker Swarm / Kubernetes (Фаза 2) |

---

## Этапы реализации

### Фаза 0: Подготовка и настройка инфраструктуры

**Описание:** Создание базовой инфраструктуры проекта

#### Задачи

##### P0-1: Инициализация репозитория

Создание структуры проекта, настройка git.

**Результаты:**
- Monorepo структура (backend/, frontend/)
- .gitignore, .editorconfig
- README.md с инструкциями

##### P0-2: Настройка Docker

Контейнеризация сервисов.

**Результаты:**
- Dockerfile для backend
- Dockerfile для frontend
- docker-compose.yml для локальной разработки
- docker-compose.prod.yml для продакшена

**Зависимости:** P0-1

##### P0-3: Настройка CI/CD

Автоматизация сборки и тестирования.

**Результаты:**
- GitHub Actions workflow для тестов
- GitHub Actions workflow для сборки образов
- Линтеры и форматтеры (ruff, eslint, prettier)

**Зависимости:** P0-1

##### P0-4: Настройка базы данных

PostgreSQL + миграции.

**Результаты:**
- Alembic конфигурация
- Начальные миграции для всех сущностей
- Сиды для тестовых данных

**Зависимости:** P0-2

#### Контрольная точка

**Название:** Инфраструктура готова

**Критерии:**
- Проект запускается одной командой (docker-compose up)
- CI проходит для пустого проекта
- База данных мигрирована

---

### Фаза 1: MVP — Базовый функционал

**Описание:** Минимально жизнеспособный продукт с основными функциями

#### 1.1 Аутентификация

##### P1.1-1: Backend: Auth endpoints

Регистрация, логин, JWT.

**Результаты:**
- POST /auth/register
- POST /auth/login
- POST /auth/refresh
- GET /auth/me

**Критерии приёмки:**
- Регистрация создаёт пользователя
- Логин возвращает JWT
- Защищённые эндпоинты требуют токен

##### P1.1-2: Frontend: Auth UI

Формы входа и регистрации.

**Результаты:**
- Страница /login
- Страница /register
- Хранение токена
- Protected routes

**Зависимости:** P1.1-1

#### 1.2 Загрузка и библиотека

##### P1.2-1: Backend: Song upload

Загрузка и обработка аудиофайлов.

**Результаты:**
- POST /songs — загрузка файла
- Извлечение метаданных (mutagen)
- Сохранение файла в storage
- POST /songs/batch — массовая загрузка

**Критерии приёмки:**
- MP3, FLAC, OGG загружаются
- Метаданные извлекаются автоматически
- Обложка сохраняется

##### P1.2-2: Backend: Songs CRUD

Операции с песнями.

**Результаты:**
- GET /songs — список с пагинацией
- GET /songs/{id} — детали
- PATCH /songs/{id} — обновление
- DELETE /songs/{id} — удаление

**Зависимости:** P1.2-1

##### P1.2-3: Frontend: Library UI

Интерфейс библиотеки.

**Результаты:**
- Страница /library
- Список треков (таблица)
- Drag-and-drop загрузка
- Индикатор прогресса загрузки

**Зависимости:** P1.2-2

#### 1.3 Плеер

##### P1.3-1: Backend: Audio streaming

Стриминг аудиофайлов.

**Результаты:**
- GET /songs/{id}/stream
- Поддержка Range requests
- Корректные Content-Type

**Критерии приёмки:**
- Аудио воспроизводится в браузере
- Seek работает

##### P1.3-2: Frontend: Audio Player

Компонент плеера.

**Результаты:**
- Player component (fixed bottom)
- Play/Pause, Prev, Next
- Progress bar с seek
- Volume control
- Shuffle, Repeat

**Зависимости:** P1.3-1

##### P1.3-3: Frontend: Queue management

Очередь воспроизведения.

**Результаты:**
- Queue state (Pinia)
- Queue panel (slide-out)
- Add to queue action
- Drag-and-drop reorder

**Зависимости:** P1.3-2

#### Контрольная точка

**Название:** MVP Ready

**Критерии:**
- Пользователь может зарегистрироваться
- Пользователь может загрузить музыку
- Пользователь может слушать музыку
- Работает очередь воспроизведения

---

### Фаза 2: Плейлисты и организация

**Описание:** Функции организации музыки

#### Задачи

##### P2-1: Backend: Playlists CRUD

API для плейлистов.

**Результаты:**
- GET /playlists
- POST /playlists
- GET /playlists/{id}
- PATCH /playlists/{id}
- DELETE /playlists/{id}
- POST /playlists/{id}/songs
- DELETE /playlists/{id}/songs/{song_id}
- PUT /playlists/{id}/songs/order

##### P2-2: Frontend: Playlist UI

Интерфейс плейлистов.

**Результаты:**
- Sidebar с плейлистами
- Страница плейлиста
- Создание плейлиста (modal)
- Добавление в плейлист (context menu)
- Drag-and-drop порядка

**Зависимости:** P2-1

##### P2-3: Backend: Tags

Система тегов.

**Результаты:**
- CRUD для тегов
- Привязка тегов к песням
- Фильтрация по тегам

##### P2-4: Frontend: Tags UI

Интерфейс тегов.

**Результаты:**
- Отображение тегов на треках
- Добавление тегов (inline)
- Фильтр по тегам

**Зависимости:** P2-3

##### P2-5: Search & Filters

Поиск и фильтрация.

**Результаты:**
- GET /search endpoint
- Global search (Cmd+K)
- Фильтры в библиотеке
- Сортировка

#### Контрольная точка

**Название:** Организация готова

**Критерии:**
- Плейлисты работают полностью
- Теги можно добавлять и фильтровать
- Поиск находит треки

---

### Фаза 3: Статистика и история

**Описание:** Трекинг прослушиваний и аналитика

#### Задачи

##### P3-1: Backend: Play tracking

Запись прослушиваний.

**Результаты:**
- POST /stats/play
- Обновление play_count и last_played_at
- Запись в listening_history

**Критерии приёмки:**
- Каждое воспроизведение логируется
- Записывается контекст (playlist, queue)

##### P3-2: Frontend: Play events

Отправка событий воспроизведения.

**Результаты:**
- Интеграция с плеером
- Определение «completed» (>90%)
- Определение «skipped» (<30 sec)

**Зависимости:** P3-1

##### P3-3: Backend: Statistics API

API статистики.

**Результаты:**
- GET /stats/overview
- GET /stats/top-songs
- GET /stats/history
- Агрегация по периодам

**Зависимости:** P3-1

##### P3-4: Frontend: Stats Dashboard

Дашборд статистики.

**Результаты:**
- Страница /stats
- Виджеты метрик
- Графики (используя библиотеку визуализации)
- Переключатель периода

**Зависимости:** P3-3

#### Контрольная точка

**Название:** Статистика работает

**Критерии:**
- Прослушивания записываются
- Дашборд показывает данные
- Работают топ-треки и история

---

### Фаза 4: Цепочки настроений

**Описание:** Ключевой дифференциатор продукта

#### Задачи

##### P4-1: Backend: Mood Chains CRUD

Базовые операции с цепочками.

**Результаты:**
- POST /mood-chains
- GET /mood-chains
- GET /mood-chains/{id}
- PATCH /mood-chains/{id}
- DELETE /mood-chains/{id}

##### P4-2: Backend: Chain from History

Создание из истории.

**Результаты:**
- POST /mood-chains/from-history
- Анализ переходов между треками
- Расчёт весов переходов

**Зависимости:** P3-1

##### P4-3: Backend: Next track recommendation

Рекомендация следующего трека.

**Результаты:**
- GET /mood-chains/{id}/next
- Алгоритм на основе весов и истории
- Учёт transition_style

**Зависимости:** P4-1, P3-1

##### P4-4: Frontend: Chain Builder

Визуальный конструктор.

**Результаты:**
- Страница создания цепочки
- Визуализация связей
- Добавление треков с поиском
- Настройка стиля перехода

**Зависимости:** P4-1

##### P4-5: Frontend: Chain Playback

Воспроизведение с предложениями.

**Результаты:**
- Интеграция с плеером
- UI предложений следующего трека
- Авто-выбор по таймауту
- Crossfade между треками

**Зависимости:** P4-3

#### Контрольная точка

**Название:** Цепочки работают

**Критерии:**
- Можно создать цепочку вручную
- Можно создать из истории
- При воспроизведении предлагает треки
- Выбор влияет на следующие предложения

---

### Фаза 5: Рекомендации

**Описание:** Интеллектуальные рекомендации

#### Задачи

##### P5-1: Backend: Similar songs

Похожие песни.

**Результаты:**
- GET /recommendations/similar/{song_id}
- Алгоритм на основе жанра, BPM, energy
- Использование истории прослушиваний

##### P5-2: Backend: Discovery

Рекомендации для открытий.

**Результаты:**
- GET /recommendations/discover
- «Давно не слушали»
- «На основе любимого»

##### P5-3: Frontend: Recommendations UI

Интерфейс рекомендаций.

**Результаты:**
- Секция на главной
- Карточки рекомендаций
- «Похожие» на странице трека

**Зависимости:** P5-1, P5-2

#### Контрольная точка

**Название:** Рекомендации работают

**Критерии:**
- Похожие треки показываются
- Раздел «Открытия» на главной

---

### Фаза 6: Полировка и оптимизация

**Описание:** Улучшение UX и производительности

#### Задачи

##### P6-1: PWA & Offline

Офлайн-функциональность.

**Результаты:**
- Service Worker
- Кэширование статики
- Офлайн-режим для закэшированных треков
- Manifest.json

##### P6-2: Performance optimization

Оптимизация производительности.

**Результаты:**
- Lazy loading компонентов
- Виртуализация длинных списков
- Оптимизация запросов (кэширование)
- Image optimization

##### P6-3: Mobile responsiveness

Адаптивность под мобильные.

**Результаты:**
- Мобильная навигация
- Touch-friendly controls
- Мобильный плеер

##### P6-4: Keyboard shortcuts

Горячие клавиши.

**Результаты:**
- Глобальные шорткаты
- Навигация по списку
- Подсказки шорткатов

##### P6-5: Dark/Light theme

Темы оформления.

**Результаты:**
- Переключатель темы
- Системная тема
- Сохранение предпочтений

#### Контрольная точка

**Название:** Продакшн готов

**Критерии:**
- PWA устанавливается
- Работает на мобильных
- Lighthouse score > 90

---

## Зависимости между этапами

```
Phase 0 ─────────────────────────────────────────────────────────────────┐
    │                                                                     │
    ▼                                                                     │
Phase 1 (MVP)                                                            │
    │                                                                     │
    ├──────────────────┬──────────────────┐                              │
    ▼                  ▼                  ▼                              │
Phase 2            Phase 3            Phase 4                            │
(Playlists)        (Stats)        (Mood Chains)                          │
    │                  │                  │                              │
    │                  │                  │                              │
    │                  └──────────────────┤                              │
    │                                     │                              │
    └──────────────────┬──────────────────┘                              │
                       ▼                                                  │
                   Phase 5                                                │
               (Recommendations)                                          │
                       │                                                  │
                       ▼                                                  │
                   Phase 6 ◄──────────────────────────────────────────────┘
                  (Polish)
```

### Примечания

- Фаза 1 (MVP) — обязательный фундамент для всего остального
- Фазы 2, 3, 4 могут разрабатываться параллельно разными разработчиками
- Фаза 4 (Цепочки) зависит от Фазы 3 (Статистика) для создания из истории
- Фаза 5 зависит от статистики и истории прослушиваний
- Фаза 6 начинается после завершения основного функционала

---

## Контрольные точки

| Название | После фазы | Критерии |
|----------|------------|----------|
| Alpha Release | 1 | Базовый функционал работает, внутреннее тестирование |
| Beta Release | 4 | Все основные функции готовы, закрытое бета-тестирование, сбор обратной связи |
| Release Candidate | 5 | Все функции работают, исправлены критические баги, документация готова |
| Production Release | 6 | Все тесты проходят, performance оптимизирован, готов к публичному использованию |

---

## Риски и митигация

### Технические риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Сложность алгоритма рекомендаций | Средняя | Среднее | Начать с простых эвристик, усложнять итеративно |
| Производительность при большой библиотеке | Средняя | Высокое | Раннее нагрузочное тестирование, индексы в БД |
| Проблемы с аудио-стримингом | Низкая | Высокое | Использовать проверенные решения (nginx, CDN) |

### Организационные риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Расширение scope | Высокая | Среднее | Строгое следование MVP, документирование идей на будущее |
| Технический долг | Средняя | Среднее | Code review, рефакторинг в каждом спринте |

---

## Метрики успеха

### Технические метрики

| Метрика | Цель |
|---------|------|
| Test coverage | > 80% |
| Lighthouse Performance | > 90 |
| API response time (p95) | < 200ms |
| Time to first play | < 3 секунды |

### Продуктовые метрики

| Метрика | Цель |
|---------|------|
| Успешная загрузка файлов | > 99% |
| Время до первого трека | < 30 секунд после регистрации |
| Использование цепочек настроений | > 30% активных пользователей |

---

## Команда и роли

### Рекомендуемый состав

| Роль | Количество | Ответственность |
|------|------------|-----------------|
| Backend Developer | 1 | API development, Database design, Audio processing |
| Frontend Developer | 1 | Vue.js components, State management, Audio player |
| Full-stack / DevOps | 1 | Infrastructure, CI/CD, Deployment |

### Минимальный состав

Один full-stack разработчик может реализовать MVP.

**Особенности:**
- Увеличение сроков
- Фокус на core features
- Использование готовых решений
